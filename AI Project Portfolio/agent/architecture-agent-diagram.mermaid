flowchart TD
    START([User Selects Architecture Agent]) --> CHECK_AUTH{User Authenticated?}
    CHECK_AUTH -->|No| LOGIN[Redirect to Login]
    CHECK_AUTH -->|Yes| PROJ_CHECK{Existing Project?}
    
    LOGIN --> AUTH_SUCCESS[Authentication Success]
    AUTH_SUCCESS --> PROJ_CHECK
    
    PROJ_CHECK -->|Yes| LOAD_PROJ[Load Project Data]
    PROJ_CHECK -->|No| NEW_PROJ[Create New Project]
    
    NEW_PROJ --> PROJ_SETUP[Project Setup Form<br/>â€¢ Name & Description<br/>â€¢ Project Type<br/>â€¢ Budget Range]
    PROJ_SETUP --> SAVE_PROJ[Save Project to Supabase]
    SAVE_PROJ --> MAIN_MENU
    
    LOAD_PROJ --> MAIN_MENU[Architecture Main Menu<br/>ğŸ“ Generate Exterior<br/>ğŸ  Create Floor Plan<br/>ğŸª‘ Design Interior<br/>ğŸ“š View Library]
    
    MAIN_MENU --> CHOICE{Select Action}
    
    CHOICE --> EXT_GEN[Generate Exterior]
    CHOICE --> FLOOR_PLAN[Create Floor Plan]
    CHOICE --> INT_DES[Design Interior]
    CHOICE --> VIEW_LIB[View Design Library]
    
    %% Exterior Generation Flow
    EXT_GEN --> EXT_FORM[Exterior Preferences Form<br/>â€¢ Architectural Style<br/>â€¢ Square Footage<br/>â€¢ Number of Stories<br/>â€¢ Color Preferences<br/>â€¢ Material Preferences]
    EXT_FORM --> EXT_INPUTS{Validate Inputs}
    EXT_INPUTS -->|Invalid| EXT_ERROR[âŒ Show Error Message<br/>â€¢ Missing required fields<br/>â€¢ Invalid values<br/>â€¢ Budget constraints]
    EXT_ERROR --> EXT_FORM
    
    EXT_INPUTS -->|Valid| MODEL_SEL[Select AI Model<br/>ğŸ¤– Claude 3.5 Sonnet<br/>ğŸ¨ DALL-E 3<br/>ğŸ–¼ï¸ Midjourney<br/>âš¡ Stable Diffusion]
    MODEL_SEL --> MODEL_CHECK{Model Available?}
    MODEL_CHECK -->|No| MODEL_ERROR[âŒ Model Unavailable<br/>â€¢ Service down<br/>â€¢ Rate limit exceeded<br/>â€¢ Insufficient credits]
    MODEL_ERROR --> MODEL_SEL
    
    MODEL_CHECK -->|Yes| GEN_PROMPT[Generate AI Prompt<br/>â€¢ Style: Modern Farmhouse<br/>â€¢ Size: 2500 sq ft<br/>â€¢ Stories: 2-story<br/>â€¢ Materials: Brick & Wood<br/>â€¢ Setting: Suburban]
    GEN_PROMPT --> API_CALL[Call OpenRouter API<br/>POST /api/generate<br/>Headers: Authorization<br/>Body: Prompt + Parameters]
    API_CALL --> API_RESP{API Response OK?}
    
    API_RESP -->|Error| API_ERROR[âŒ Show API Error<br/>â€¢ Timeout<br/>â€¢ Invalid response<br/>â€¢ Server error<br/>â€¢ Quota exceeded]
    API_ERROR --> MODEL_SEL
    
    API_RESP -->|Success| PROC_IMG[Process Generated Image<br/>â€¢ Resize & optimize<br/>â€¢ Extract metadata<br/>â€¢ Generate thumbnails<br/>â€¢ Quality check]
    PROC_IMG --> SAVE_IMG[Save to Supabase Storage<br/>â€¢ Upload to CDN<br/>â€¢ Generate public URL<br/>â€¢ Set permissions<br/>â€¢ Create database record]
    SAVE_IMG --> UPDATE_DB[Update Project Database<br/>â€¢ Link to project<br/>â€¢ Save parameters<br/>â€¢ Update timestamp<br/>â€¢ Increment version]
    UPDATE_DB --> SYNC_EVENT[Trigger Sync Event<br/>ğŸ“¡ Notify other agents<br/>ğŸ”„ Update project status<br/>ğŸ“Š Log activity]
    SYNC_EVENT --> SHOW_EXT[Display Generated Exterior<br/>ğŸ–¼ï¸ High-res preview<br/>ğŸ“‹ Generation details<br/>â­ Quality rating<br/>ğŸ”§ Edit options]
    
    SHOW_EXT --> EXT_ACTIONS{User Action}
    EXT_ACTIONS --> REGENERATE[ğŸ”„ Regenerate<br/>Different style/parameters]
    EXT_ACTIONS --> SAVE_FINAL[ğŸ’¾ Save to Library<br/>Add to favorites]
    EXT_ACTIONS --> MODIFY[âœï¸ Modify Parameters<br/>Adjust style/colors]
    EXT_ACTIONS --> EXPORT_EXT[ğŸ“¤ Export Design<br/>Download files]
    
    REGENERATE --> GEN_PROMPT
    MODIFY --> EXT_FORM
    SAVE_FINAL --> LIB_SAVE[Add to Design Library<br/>â€¢ Categorize by style<br/>â€¢ Add tags<br/>â€¢ Set privacy<br/>â€¢ Generate preview]
    LIB_SAVE --> NOTIFY_AGENTS[Notify Other Agents<br/>ğŸ“¤ Developer: Property requirements<br/>ğŸ“¤ Builder: Cost implications<br/>ğŸ“¤ Construction: Method impact<br/>ğŸ“¤ Zoning: Design compliance]
    
    %% Floor Plan Flow
    FLOOR_PLAN --> FLOOR_FORM[Floor Plan Requirements<br/>â€¢ Bedrooms: 4<br/>â€¢ Bathrooms: 3<br/>â€¢ Square Footage: 2500<br/>â€¢ Special Rooms: Office, Gym<br/>â€¢ Accessibility Needs]
    FLOOR_FORM --> FLOOR_INPUTS{Validate Requirements}
    FLOOR_INPUTS -->|Invalid| FLOOR_ERROR[âŒ Show Requirements Error<br/>â€¢ Impossible layout<br/>â€¢ Size constraints<br/>â€¢ Code violations]
    FLOOR_ERROR --> FLOOR_FORM
    
    FLOOR_INPUTS -->|Valid| FLOOR_TYPE{Creation Method}
    FLOOR_TYPE --> AI_FLOOR[ğŸ¤– AI Generated<br/>Smart layout optimization]
    FLOOR_TYPE --> MANUAL_FLOOR[âœï¸ Manual Editor<br/>Drag & drop interface]
    FLOOR_TYPE --> TEMPLATE[ğŸ“‹ Use Template<br/>Pre-designed layouts]
    
    AI_FLOOR --> FLOOR_AI_PROMPT[Generate Floor Plan Prompt<br/>â€¢ Room requirements<br/>â€¢ Traffic flow optimization<br/>â€¢ Natural light preferences<br/>â€¢ Privacy considerations]
    FLOOR_AI_PROMPT --> FLOOR_API[Call Floor Plan API<br/>â€¢ Generate layout<br/>â€¢ Optimize room sizes<br/>â€¢ Add standard fixtures<br/>â€¢ Check building codes]
    FLOOR_API --> FLOOR_PROC[Process Floor Plan Data<br/>â€¢ Convert to vector format<br/>â€¢ Calculate room areas<br/>â€¢ Generate room labels<br/>â€¢ Create scale drawings]
    
    MANUAL_FLOOR --> FLOOR_EDITOR[Open Floor Plan Editor<br/>ğŸ¨ Drawing tools<br/>ğŸ“ Measurement tools<br/>ğŸšª Door/window library<br/>ğŸª‘ Fixture library]
    FLOOR_EDITOR --> EDITOR_TOOLS[Load Editor Tools<br/>â€¢ Wall drawing<br/>â€¢ Room creation<br/>â€¢ Dimension tools<br/>â€¢ Symbol library]
    EDITOR_TOOLS --> DRAW_MODE[Drawing Mode<br/>â€¢ Click to add walls<br/>â€¢ Snap to grid<br/>â€¢ Auto-complete rooms<br/>â€¢ Real-time measurements]
    DRAW_MODE --> EDITOR_SAVE[Save Editor Changes<br/>â€¢ Auto-save every 30s<br/>â€¢ Version history<br/>â€¢ Undo/redo stack<br/>â€¢ Validation checks]
    
    TEMPLATE --> TEMPLATE_LIB[Load Template Library<br/>ğŸ  Single Family<br/>ğŸ¢ Multi-family<br/>ğŸ¬ Commercial<br/>â™¿ Accessible designs]
    TEMPLATE_LIB --> SELECT_TEMPLATE[Select Template<br/>â€¢ Preview 3D view<br/>â€¢ Check compatibility<br/>â€¢ Review specifications<br/>â€¢ Compare options]
    SELECT_TEMPLATE --> CUSTOMIZE[Customize Template<br/>â€¢ Resize rooms<br/>â€¢ Move walls<br/>â€¢ Add/remove features<br/>â€¢ Update materials]
    CUSTOMIZE --> TEMPLATE_SAVE[Save Customized Plan<br/>â€¢ Generate new version<br/>â€¢ Update metadata<br/>â€¢ Recalculate areas<br/>â€¢ Validate changes]
    
    FLOOR_PROC --> FLOOR_DISPLAY[Display Floor Plan<br/>ğŸ“ 2D view with dimensions<br/>ğŸ  3D preview<br/>ğŸ“Š Room area calculations<br/>ğŸ’° Estimated costs]
    EDITOR_SAVE --> FLOOR_DISPLAY
    TEMPLATE_SAVE --> FLOOR_DISPLAY
    
    FLOOR_DISPLAY --> FLOOR_ACTIONS{User Action}
    FLOOR_ACTIONS --> FLOOR_EDIT[âœï¸ Edit Plan<br/>Modify layout]
    FLOOR_ACTIONS --> FLOOR_SAVE[ğŸ’¾ Save Plan<br/>Add to project]
    FLOOR_ACTIONS --> FLOOR_3D[ğŸ  View 3D<br/>Virtual walkthrough]
    FLOOR_ACTIONS --> FLOOR_EXPORT[ğŸ“¤ Export Plan<br/>PDF, CAD, images]
    
    FLOOR_EDIT --> FLOOR_EDITOR
    FLOOR_SAVE --> UPDATE_FLOOR_DB[Update Database<br/>â€¢ Save floor plan data<br/>â€¢ Calculate total area<br/>â€¢ Update project status<br/>â€¢ Trigger cost recalculation]
    FLOOR_3D --> RENDER_3D[Render 3D View<br/>â€¢ Generate 3D model<br/>â€¢ Apply textures<br/>â€¢ Set lighting<br/>â€¢ Create camera paths]
    RENDER_3D --> DISPLAY_3D[Display 3D Model<br/>ğŸ® Interactive controls<br/>ğŸš¶ Virtual walkthrough<br/>ğŸ“¸ Screenshot capture<br/>ğŸ¬ Animation export]
    
    %% Interior Design Flow
    INT_DES --> ROOM_SEL[Select Room Type<br/>ğŸ›ï¸ Bedroom<br/>ğŸ‘¨â€ğŸ³ Kitchen<br/>ğŸ›‹ï¸ Living Room<br/>ğŸš¿ Bathroom<br/>ğŸ¢ Office]
    ROOM_SEL --> STYLE_SEL[Select Interior Style<br/>ğŸ  Modern<br/>ğŸŒ¾ Farmhouse<br/>âœ¨ Contemporary<br/>ğŸ›ï¸ Traditional<br/>ğŸ­ Industrial<br/>ğŸŒ¿ Scandinavian]
    STYLE_SEL --> BUDGET_SET[Set Budget Range<br/>ğŸ’° $5,000 - $15,000<br/>ğŸ’ $15,000 - $30,000<br/>ğŸ‘‘ $30,000+<br/>ğŸ¯ Custom budget]
    BUDGET_SET --> INT_GENERATE[Generate Interior<br/>â€¢ AI furniture placement<br/>â€¢ Color coordination<br/>â€¢ Lighting design<br/>â€¢ Accessory selection]
    
    INT_GENERATE --> INT_API[Call Interior Design API<br/>â€¢ Room analysis<br/>â€¢ Style application<br/>â€¢ Furniture recommendation<br/>â€¢ 3D rendering]
    INT_API --> PRODUCT_MATCH[Match Products<br/>ğŸ›‹ï¸ Amazon furniture<br/>ğŸ  Wayfair catalog<br/>ğŸª‘ IKEA products<br/>ğŸ’¡ Lighting fixtures]
    PRODUCT_MATCH --> PRICE_CALC[Calculate Pricing<br/>â€¢ Item costs<br/>â€¢ Shipping fees<br/>â€¢ Tax calculations<br/>â€¢ Discount applications]
    PRICE_CALC --> INT_RESULT[Show Interior Design<br/>ğŸ–¼ï¸ 3D rendered room<br/>ğŸ›’ Shopping list<br/>ğŸ’° Total cost breakdown<br/>ğŸ”— Purchase links]
    
    INT_RESULT --> INT_ACTIONS{User Action}
    INT_ACTIONS --> PRODUCT_LINKS[ğŸ›’ View Product Links<br/>Direct to vendor sites]
    INT_ACTIONS --> SAVE_INT[ğŸ’¾ Save Interior<br/>Add to library]
    INT_ACTIONS --> MODIFY_INT[âœï¸ Modify Design<br/>Change style/budget]
    INT_ACTIONS --> SHARE_INT[ğŸ“¤ Share Design<br/>Export images/lists]
    
    PRODUCT_LINKS --> VENDOR_REDIRECT[Redirect to Vendor<br/>â€¢ Amazon product page<br/>â€¢ Wayfair catalog<br/>â€¢ Local retailer<br/>â€¢ Track affiliate links]
    SAVE_INT --> INT_LIB[Add to Library<br/>â€¢ Save design data<br/>â€¢ Store product list<br/>â€¢ Generate preview<br/>â€¢ Set categories]
    MODIFY_INT --> STYLE_SEL
    
    %% Design Library Flow
    VIEW_LIB --> LIB_DISPLAY[Display Design Library<br/>ğŸ“‚ All designs<br/>â­ Favorites<br/>ğŸ“… Recent<br/>ğŸ·ï¸ By category]
    LIB_DISPLAY --> LIB_FILTER{Filter Options}
    LIB_FILTER --> FILTER_TYPE[Filter by Type<br/>ğŸ  Exteriors<br/>ğŸ“ Floor Plans<br/>ğŸª‘ Interiors]
    LIB_FILTER --> FILTER_DATE[Filter by Date<br/>ğŸ“… Last week<br/>ğŸ“… Last month<br/>ğŸ“… Custom range]
    LIB_FILTER --> FILTER_STYLE[Filter by Style<br/>ğŸ  Modern<br/>ğŸŒ¾ Farmhouse<br/>âœ¨ Contemporary]
    LIB_FILTER --> SEARCH_LIB[ğŸ” Search Library<br/>Keywords, tags, names]
    
    FILTER_TYPE --> FILTERED_RESULTS[Show Filtered Results<br/>ğŸ“Š Grid view<br/>ğŸ“‹ List view<br/>ğŸ“± Card view]
    FILTER_DATE --> FILTERED_RESULTS
    FILTER_STYLE --> FILTERED_RESULTS
    SEARCH_LIB --> FILTERED_RESULTS
    
    FILTERED_RESULTS --> LIB_ACTIONS{Library Actions}
    LIB_ACTIONS --> VIEW_DETAIL[ğŸ‘ï¸ View Details<br/>Full specifications]
    LIB_ACTIONS --> DUPLICATE[ğŸ“‹ Duplicate Design<br/>Create copy for editing]
    LIB_ACTIONS --> DELETE_ITEM[ğŸ—‘ï¸ Delete Item<br/>Remove from library]
    LIB_ACTIONS --> EXPORT_DESIGN[ğŸ“¤ Export Design<br/>Download files/data]
    LIB_ACTIONS --> SHARE_DESIGN[ğŸ”— Share Design<br/>Generate share link]
    
    %% Integration & Sync
    NOTIFY_AGENTS --> SYNC_DEVELOPER[ğŸ“¤ Sync to Developer Agent<br/>â€¢ Update property search criteria<br/>â€¢ Adjust size requirements<br/>â€¢ Modify location preferences<br/>â€¢ Update budget parameters]
    NOTIFY_AGENTS --> SYNC_BUILDER[ğŸ“¤ Sync to Builder Agent<br/>â€¢ Recalculate material costs<br/>â€¢ Update labor estimates<br/>â€¢ Adjust timeline<br/>â€¢ Revise contractor requirements]
    NOTIFY_AGENTS --> SYNC_CONSTRUCTION[ğŸ“¤ Sync to Construction Agent<br/>â€¢ Update construction methods<br/>â€¢ Adjust equipment needs<br/>â€¢ Revise safety requirements<br/>â€¢ Update quality standards]
    NOTIFY_AGENTS --> SYNC_ZONING[ğŸ“¤ Sync to Zoning Agent<br/>â€¢ Check design compliance<br/>â€¢ Update permit requirements<br/>â€¢ Verify setback compliance<br/>â€¢ Adjust legal documentation]
    
    SYNC_DEVELOPER --> DEV_UPDATE[ğŸ”„ Update Property Requirements<br/>â€¢ Minimum lot size<br/>â€¢ Zoning requirements<br/>â€¢ Utility access needs<br/>â€¢ Neighborhood preferences]
    SYNC_BUILDER --> BUILD_UPDATE[ğŸ”„ Update Cost Estimates<br/>â€¢ Material quantity changes<br/>â€¢ Labor hour adjustments<br/>â€¢ Equipment rental updates<br/>â€¢ Timeline modifications]
    SYNC_CONSTRUCTION --> CONST_UPDATE[ğŸ”„ Update Construction Methods<br/>â€¢ Foundation requirements<br/>â€¢ Framing specifications<br/>â€¢ Systems integration<br/>â€¢ Quality checkpoints]
    SYNC_ZONING --> ZONE_UPDATE[ğŸ”„ Update Permit Requirements<br/>â€¢ Building permit scope<br/>â€¢ Inspection schedules<br/>â€¢ Code compliance checks<br/>â€¢ Documentation updates]
    
    %% Exit Points and Completion
    VIEW_DETAIL --> MAIN_MENU
    DUPLICATE --> MAIN_MENU
    DELETE_ITEM --> MAIN_MENU
    EXPORT_DESIGN --> DOWNLOAD[ğŸ“¥ Download Files<br/>â€¢ PDF reports<br/>â€¢ CAD files<br/>â€¢ 3D models<br/>â€¢ Image renders]
    SHARE_DESIGN --> SHARE_LINK[ğŸ”— Generate Share Link<br/>â€¢ Public/private options<br/>â€¢ Expiration settings<br/>â€¢ Access permissions<br/>â€¢ Usage tracking]
    DOWNLOAD --> MAIN_MENU
    SHARE_LINK --> MAIN_MENU
    VENDOR_REDIRECT --> MAIN_MENU
    INT_LIB --> MAIN_MENU
    DISPLAY_3D --> MAIN_MENU
    UPDATE_FLOOR_DB --> MAIN_MENU
    DEV_UPDATE --> COMPLETE[âœ… Sync Complete<br/>All agents updated]
    BUILD_UPDATE --> COMPLETE
    CONST_UPDATE --> COMPLETE
    ZONE_UPDATE --> COMPLETE
    COMPLETE --> MAIN_MENU
    
    %% Error Handling and Logging
    API_ERROR --> ERROR_LOG[ğŸ“ Log Error<br/>â€¢ Error type & code<br/>â€¢ User session data<br/>â€¢ API response details<br/>â€¢ Timestamp & duration]
    MODEL_ERROR --> ERROR_LOG
    FLOOR_ERROR --> ERROR_LOG
    ERROR_LOG --> ALERT_USER[ğŸš¨ Alert User<br/>â€¢ User-friendly message<br/>â€¢ Suggested actions<br/>â€¢ Support contact info<br/>â€¢ Error reference ID]
    ALERT_USER --> MAIN_MENU

    %% Styling
    classDef startEnd fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef process fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef error fill:#ffebee,stroke:#b71c1c,stroke-width:2px
    classDef success fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef sync fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    
    class START,COMPLETE startEnd
    class EXT_FORM,FLOOR_FORM,INT_GENERATE process
    class CHECK_AUTH,PROJ_CHECK,CHOICE decision
    class EXT_ERROR,MODEL_ERROR,API_ERROR,FLOOR_ERROR error
    class SAVE_FINAL,LIB_SAVE,UPDATE_FLOOR_DB success
    class SYNC_EVENT,NOTIFY_AGENTS,DEV_UPDATE,BUILD_UPDATE,CONST_UPDATE,ZONE_UPDATE sync